#!/home/simbed/.rbenv/shims/ruby
# frozen_string_literal: true

# get the shebang line from $which ruby
# make this file executable with  $chmod +x file_name.rb
require 'dotenv'
PROJECT_ROOT = File.expand_path('..', __dir__)
Dir.chdir(PROJECT_ROOT)
Dotenv.load('.env', '.env.secrets')
require_relative '../lib/cancellation_monitor'
require_relative '../lib/state_recorder'
PARK_VENUE = ENV['PARK_NAME'].downcase
URL = "https://www.parkrun.org.uk/#{PARK_VENUE}/"

if StateRecorder.new.already_sent?
  puts 'Warning already sent for this week. No action taken.'
else
  channels = []

  channels << EmailNotifier.new if ENV['EMAIL_ENABLED'] == 'true'
  channels << WhatsAppNotifier.new if ENV['WHATSAPP_ENABLED'] == 'true'

  notifier = Notifier.new(channels: channels)
  CancellationMonitor.new(url: URL, notifier: notifier).run
end
